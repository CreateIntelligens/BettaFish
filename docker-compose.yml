services:
  nginx:
    image: nginx:alpine
    container_name: bettafish-nginx
    restart: unless-stopped
    ports:
      - "8903:80"  # 對外統一使用 8903 端口
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - bettafish
    networks:
      - bettafish-network

  bettafish:
    image: ghcr.io/666ghj/bettafish:latest
    # Speed up mirror
    # image: ghcr.nju.edu.cn/666ghj/bettafish:latest
    container_name: bettafish
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_ENABLE_FILE_WATCHER=false
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # 不再直接暴露端口,由 Nginx 統一代理
    expose:
      - "5000"
      - "8501"
      - "8502"
      - "8503"
    networks:
      - bettafish-network
    volumes:
      # 掛載源代碼 (開發模式)
      - .:/app
      # 但排除這些目錄,避免容器內外衝突
      - /app/__pycache__
      - /app/.pytest_cache
      - /app/db_data
      # 持久化數據目錄
      - ./logs:/app/logs
      - ./final_reports:/app/final_reports
      - ./insight_engine_streamlit_reports:/app/insight_engine_streamlit_reports
      - ./media_engine_streamlit_reports:/app/media_engine_streamlit_reports
      - ./query_engine_streamlit_reports:/app/query_engine_streamlit_reports

  db:
    image: postgres:15
    container_name: bettafish-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: bettafish
      POSTGRES_PASSWORD: bettafish
      POSTGRES_DB: bettafish
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5444:5432"  # 宿主機 5444 映射到容器內 5432 (可選,用於外部連接)
    volumes:
      - ./db_data:/var/lib/postgresql/data
    networks:
      - bettafish-network

networks:
  bettafish-network:
    driver: bridge
